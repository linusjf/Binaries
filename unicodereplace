#!/usr/bin/env bash

if [ $# -lt 1 ]; then
  echo "Usage: $0 file1 [file2 ...]"
  exit 1
fi

declare -A replacements
declare -A seen_chars

# Gather unique Unicode characters
for file in "$@"; do
  if [ ! -f "$file" ]; then
    echo "File not found: $file"
    continue
  fi

  while IFS= read -r -n1 char; do
    [[ -z "$char" ]] && continue
    if [[ "$char" =~ [^[:ascii:]] && -z "${seen_chars[$char]}" ]]; then
      seen_chars["$char"]=1
    fi
  done < "$file"
done

# Prompt user for replacements
for char in "${!seen_chars[@]}"; do
  codepoint=$(printf 'U+%04X' "'$char")
  echo -e "Found Unicode character: '$char' ($codepoint)"
  read -r -p "Replace it? [y/N]: " choice
  if [[ "$choice" == [Yy]* ]]; then
    read -r -p "Replace '$char' with: " replacement
    replacements["$char"]="$replacement"
  fi
done

# Perform replacements in-place
for file in "$@"; do
  tmpfile=$(mktemp)
  cp "$file" "$tmpfile"

  for char in "${!replacements[@]}"; do
    # Escape special chars for sed
    safe_char=$(printf '%s\n' "$char" | sed -e 's/[]\/$*.^[]/\\&/g')
    safe_repl=$(printf '%s\n' "${replacements[$char]}" | sed -e 's/[\/&]/\\&/g')
    sed -i "s/$safe_char/$safe_repl/g" "$tmpfile"
  done

  mv "$tmpfile" "$file"
  echo "Updated: $file"
done
